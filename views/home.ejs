<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./partials/head') %>
    <title>Blogify</title>
    <link rel="stylesheet" href="./partials/styles.css">
  </head>
  <body>
    <%- include('./partials/navbar') %>

    <% if (Array.isArray(blogs) && blogs.length > 0) { %>
      <% blogs.forEach((blog, index) => { %> 
        <div class="card" style="width: 18rem">
          <img src="<%= blog.coverImage %>" class="card-img-top" alt="..." />
          <div class="card-body">
            <h5 class="card-title"><%= blog.title %></h5>
            <p class="card-text"><%= blog.body.substring(0, 100) %>...</p>
            <button
              type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal<%= index %>"
            >
              Read Blog
            </button>
          </div>
        </div>
    
        <!-- Modal -->
        <div
          class="modal fade"
          id="exampleModal<%= index %>"
          tabindex="-1"
          aria-labelledby="exampleModalLabel<%= index %>"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel<%= index %>">
                  <%= blog.title %>
                </h1>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <%- blog.body %> <!-- Render full blog body -->

                <hr>
                <!-- Comment form for logged-in users -->
                 <% const blogComments = comments.filter(comment => comment.blogId.toString() === blog._id.toString()); %>
                 <h4>Comments (<%= blogComments.length %>)</h4>
                <% if (locals.user) { %>
                  <div class="form-floating">
                    <form action="/user/comment/<%= blog._id %>" method="post">
                      <textarea class="form-control" placeholder="Leave a comment here" id="content" name="content" style="height: 100px"></textarea>
                      <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                  </div>
                <% } %>
                <% blogComments.forEach(comment => { %>
                  <%= comment.createdBy.profileImage %>
                  | <strong><%=comment.createdBy.fullName%></strong>
                  <%= comment.content %>
                <% }) %>
              </div>
              <div class="modal-footer">
                Published By: <%= blog.createdBy.fullName %>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <p>No blogs found</p>
    <% } %>

    <%- include('./partials/scripts') %>
  </body>
</html>
